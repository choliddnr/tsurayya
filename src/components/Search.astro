---
import { Icon } from 'astro-icon/components';
---

<div class="relative">
  <input
    type="search"
    id="search-input"
    placeholder="Search blog and projects..."
    class="w-full p-2 pl-10 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
  />
  <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
    <Icon name="heroicons:magnifying-glass" class="w-5 h-5 text-gray-500 dark:text-gray-400" />
  </div>
</div>

<div id="search-results" class="mt-4"></div>

<script>
  import { getCollection } from 'astro:content';

  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const searchResults = document.getElementById('search-results');

  async function loadSearchData() {
    const blogPosts = await getCollection('blog');
    const projects = await getCollection('projects');
    return [...blogPosts, ...projects];
  }

  let searchData = [];
  loadSearchData().then(data => {
    searchData = data;
  });

  searchInput.addEventListener('input', () => {
    const query = searchInput.value.toLowerCase();
    if (query.length < 2) {
      searchResults.innerHTML = '';
      return;
    }

    const results = searchData.filter(item => {
      const title = item.data.title.toLowerCase();
      const description = item.data.description?.toLowerCase() || '';
      const body = item.body?.toLowerCase() || '';
      return title.includes(query) || description.includes(query) || body.includes(query);
    });

    displayResults(results);
  });

  function displayResults(results) {
    if (!searchResults) return;

    if (results.length === 0) {
      searchResults.innerHTML = '<p>No results found.</p>';
      return;
    }

    const html = results.map(item => `
      <a href="/${item.collection}/${item.slug}" class="block p-4 mb-4 border border-gray-200 rounded-lg hover:bg-gray-100 dark:border-gray-700 dark:hover:bg-gray-800">
        <h3 class="text-lg font-bold">${item.data.title}</h3>
        <p class="text-sm text-gray-600 dark:text-gray-400">${item.data.description || ''}</p>
      </a>
    `).join('');

    searchResults.innerHTML = html;
  }
</script>
